<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent Dashboard</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
      padding: 20px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #333;
    }

    h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .meta {
      font-size: 13px;
      color: #888;
    }

    .meta span {
      margin-left: 16px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    th, td {
      text-align: left;
      padding: 12px 16px;
      border-bottom: 1px solid #2a2a4a;
    }

    th {
      background: #16213e;
      font-weight: 600;
      color: #aaa;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.5px;
    }

    tr:hover {
      background: #1f1f3a;
    }

    .status {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status.active { background: #4ade80; }
    .status.idle { background: #666; }

    .agent-id {
      font-weight: 600;
      font-family: monospace;
    }

    .branch {
      font-family: monospace;
      background: #2a2a4a;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 13px;
    }

    .pr-link {
      color: #60a5fa;
      text-decoration: none;
    }

    .pr-link:hover {
      text-decoration: underline;
    }

    .server-links {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .server-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #2a2a4a;
      color: #60a5fa;
      padding: 4px 10px;
      border-radius: 4px;
      text-decoration: none;
      font-size: 12px;
      font-family: monospace;
    }

    .server-link:hover {
      background: #3a3a5a;
    }

    .server-type {
      color: #888;
      font-size: 10px;
      text-transform: uppercase;
    }

    .beads {
      font-size: 13px;
    }

    .beads-count {
      display: inline-block;
      background: #2a2a4a;
      padding: 2px 8px;
      border-radius: 4px;
      margin-right: 4px;
    }

    .beads-count.in-progress {
      background: #854d0e;
      color: #fcd34d;
    }

    .beads-issues {
      font-family: monospace;
      font-size: 11px;
      color: #888;
    }

    .commit {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: #888;
      font-size: 13px;
    }

    .commit-time {
      font-size: 11px;
      color: #666;
    }

    .github-links {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .github-link {
      display: inline-block;
      background: #2a2a4a;
      color: #60a5fa;
      padding: 3px 8px;
      border-radius: 4px;
      text-decoration: none;
      font-size: 11px;
    }

    .github-link:hover {
      background: #3a3a5a;
    }

    .github-link.diff {
      background: #1e3a5f;
      color: #93c5fd;
    }

    .github-link.diff:hover {
      background: #2d4a6f;
    }

    .no-agents {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .error {
      background: #7f1d1d;
      color: #fca5a5;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .refresh-indicator {
      font-size: 12px;
      color: #666;
    }

    .refresh-indicator.refreshing {
      color: #60a5fa;
    }
  </style>
</head>
<body>
  <header>
    <h1>Agent Dashboard</h1>
    <div class="meta">
      <span id="hostname"></span>
      <span id="tailscale"></span>
      <span class="refresh-indicator" id="refresh">Auto-refresh: 10s</span>
    </div>
  </header>

  <div id="error" class="error" style="display: none;"></div>

  <div id="content">
    <div class="no-agents">Loading...</div>
  </div>

  <script>
    let refreshInterval;

    async function fetchAgents() {
      const refreshEl = document.getElementById('refresh');
      refreshEl.textContent = 'Refreshing...';
      refreshEl.classList.add('refreshing');

      try {
        const res = await fetch('/api/agents');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        renderDashboard(data);
        document.getElementById('error').style.display = 'none';
      } catch (err) {
        document.getElementById('error').textContent = `Error: ${err.message}`;
        document.getElementById('error').style.display = 'block';
      } finally {
        refreshEl.textContent = 'Auto-refresh: 10s';
        refreshEl.classList.remove('refreshing');
      }
    }

    function renderDashboard(data) {
      document.getElementById('hostname').textContent = `Host: ${data.hostname}`;

      if (data.tailscaleHostname) {
        document.getElementById('tailscale').textContent = `Tailscale: ${data.tailscaleHostname}`;
      }

      if (data.agents.length === 0) {
        document.getElementById('content').innerHTML = `
          <div class="no-agents">
            <p>No agent directories found in ~/gits/</p>
            <p style="margin-top: 8px; font-size: 13px;">Looking for directories matching pattern: *-N (e.g., swing-1, swing-2)</p>
          </div>
        `;
        return;
      }

      const rows = data.agents.map(agent => {
        const statusClass = agent.status;
        const serversHtml = agent.servers.length > 0
          ? agent.servers.map(s => {
              const url = data.tailscaleHostname ? s.tailscaleUrl : s.url;
              return `<a class="server-link" href="${url}" target="_blank">
                <span class="server-type">${s.type}</span>
                :${s.port}
              </a>`;
            }).join('')
          : '<span style="color: #666">-</span>';

        const prHtml = agent.pr
          ? `<a class="pr-link" href="${agent.pr.url}" target="_blank">#${agent.pr.number}</a>`
          : '<span style="color: #666">-</span>';

        const beadsHtml = agent.beads
          ? `<span class="beads-count${agent.beads.inProgress > 0 ? ' in-progress' : ''}">${agent.beads.open} open</span>
             ${agent.beads.inProgress > 0 ? `<span class="beads-count in-progress">${agent.beads.inProgress} WIP</span>` : ''}
             ${agent.beads.inProgressIssues.length > 0 ? `<div class="beads-issues">${agent.beads.inProgressIssues.join(', ')}</div>` : ''}`
          : '<span style="color: #666">-</span>';

        const githubHtml = agent.github
          ? `<div class="github-links">
               <a class="github-link diff" href="${agent.github.diffUrl}" target="_blank" title="Compare ${agent.branch} to main">Diff</a>
               <a class="github-link" href="${agent.github.lastCommitUrl}" target="_blank" title="View last commit">Commit</a>
               <a class="github-link" href="${agent.github.commitsUrl}" target="_blank" title="View all commits on ${agent.branch}">History</a>
             </div>`
          : '<span style="color: #666">-</span>';

        return `
          <tr>
            <td>
              <span class="status ${statusClass}"></span>
              <span class="agent-id">${agent.id}</span>
            </td>
            <td><span class="branch">${agent.branch}</span></td>
            <td>${prHtml}</td>
            <td>${githubHtml}</td>
            <td><div class="server-links">${serversHtml}</div></td>
            <td class="beads">${beadsHtml}</td>
            <td>
              <div class="commit" title="${agent.lastCommit}">${agent.lastCommit || '-'}</div>
              <div class="commit-time">${agent.lastCommitTime || ''}</div>
            </td>
          </tr>
        `;
      }).join('');

      document.getElementById('content').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Agent</th>
              <th>Branch</th>
              <th>PR</th>
              <th>GitHub</th>
              <th>Servers</th>
              <th>Beads</th>
              <th>Last Commit</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
    }

    // Initial fetch
    fetchAgents();

    // Auto-refresh every 10 seconds
    refreshInterval = setInterval(fetchAgents, 10000);

    // Live reload - listen for server file changes
    const liveReload = new EventSource('/api/live-reload');
    liveReload.onmessage = () => {
      console.log('File changed, reloading...');
      location.reload();
    };
  </script>
</body>
</html>
